/*NO DEPENDENCIES*/


WITH var AS
    (SELECT DATEADD(MONTH, 0, sysdate)      AS run date, -- specify X depending how far we want to go back, X can be set as 0 as defaul
            DATEADD(MONTH, -2, run_date)    AS lfp_end_date,
            DATEADD (YEAR, -2, lfp_end_date) + 1 AS lfp_start_date,
            DATEADD (MONTH, -6, lfp_end_date) AS temporal_train_end_date)

-- 1.1 Getting all non Contact Us/Live Chat/MRC MOL
 , needed_data AS 
 (SELECT * 
  FROM (SELECT CASE WHEN lf.contact_id = 'Unknown' THEN lf.lead_id else lf.contact_id END       AS contact_or_lead_id
                ,lf.contact_id
                ,lf.lead_id 
                ,lf.lfp_wid 
                ,lf.mal_date
                ,lf.mql_date
                ,lf.sal_date
                ,lf.sql_date
                ,lf.sqo_date
                ,lf.swo_date
                ,lf.slo_date
                ,CASE WHEN lf.mql_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 ELSE 0 END          AS reached_mql
                ,CASE
                      WHEN lf.sal_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sal
                ,CASE 
                      WHEN lf.sal_expiration _date < TO_DATE('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sal_expiration
                ,CASE 
                      WHEN lf.sdl_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sdl
                ,CASE 
                      WHEN lf.sql_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sql
                ,CASE 
                      WHEN lf.sqo_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sqo 
                ,CASE
                      WHEN lf.swo_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1
                      ELSE 0 END                                                                         AS reached_ swo 
                ,CASE WHEN lf.slo_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 
                      ELSE 0 END                                                                         AS reached_slo
                ,CASE 
                      WHEN lower (sla tier c) = 'contact us' THEN 'Contact Us'
                      WHEN lower (campaign_category_c) = 'live chat' THEN 'Live Chat' 
                      WHEN lower (mrc_status_at_tsi_creation__c)= 'qualified - passed to sales' THEN 'MRC Generated' 
                      WHEN lower (cam.type) LIKE '%fast track%' AND lower (cam. sub_type__c) LIKE '%call down%'
                            THEN 'Fast Track - Calldown' 
                      WHEN lower (cam. type) LIKE '%fast track%' AND lower (cam. sub_type _c) LIKE '%boost%'
                            THEN 'Fast Track Boost' 
                      WHEN lower(cam. name) LIKE 'graze%' THEN 'RAZE' 
                      WHEN tsl. createdbyid = '0054z000008KeC9AAK' THEN 'Generated by Lorem' 
                      WHEN tsl. createdbyid = '00538000004CGWOAAM' THEN 'Generated by Marketo/System' 
                      WHEN tsl. createdbyid = '00550000001FBwjAAG' THEN 'Generated by Marketo/System' 
                      WHEN tsl. createdbyid = '00538000004c6aZAAA' THEN 'Generated by Marketo/System' 
                      WHEN tsl. createdbyid = '00550000003W9NaAAK' THEN 'Generated by Marketo/System' 
                      ELSE 'Others'
            END                                                                                           AS mql_type
                ,CASE WHEN reached_mal > 0 THEN 1 ELSE 0 END                                            reached_mql_score
                ,CASE WHEN reached_sal > 0 THEN 2 ELSE 0 END                                            reached_sal_score
                ,CASE WHEN reached_sql > 0 THEN 4 ELSE 0 END                                            reached_sal score
                ,CASE WHEN reached_sqo > 0 THEN 8 ELSE 0 END                                            reached_sqo_score
                ,CASE WHEN reached_swo > 0 THEN 16 ELSE 0 END                                           reached_swo_score
                ,CASE WHEN reached slo > 0 THEN 16 ELSE 0 END                                           reached_slo_score
                ,reached_mql_score + reached_sal_score + reached_sq1_score + reached_sqo_score + reached_swo_score + reached_slo_score AS progression_score
                ,lc.sfdc_account_id                                                                      AS account id 
                ,lc.email domain 
                ,CASE
                    WHEN lc.email_domain in ('gmail.com', 'hotmail.com', 'yahoo. com', 'outlook. com', 
                                             'aol.com', 'comcast.net', 'icloud.com', 'live.com', 'me.com'
                                             'verizon.net','packetstorm. com', 'allsocial. com', ' cnnbrasil.com.br', 
                                             'msn. com','mac.com', 'protonmail. com', 'example. com', 'itau-unibanco.com.br', 
                                             'qq. com', 'yandex. ru') THEN 1
                    WHEN lc.email_domain ilike '%yahoo' THEN 1
                    WHEN lc.email_domain ilike '%hotmail' THEN 1
                    WHEN lc.email_domain ilike '%testinator.com' THEN 1 
                    WHEN lc.email_domain IS NULL THEN 1 
                    ELSE 0
            END  -- by line 89 --
