/*NO DEPENDENCIES*/

WITH var AS
    (SELECT DATEADD(MONTH, 0, sysdate)      AS run date, -- specify X depending how far we want to go back, X can be set as 0 as defaul
            DATEADD(MONTH, -2, run_date)    AS lfp_end_date,
            DATEADD (YEAR, -2, lfp_end_date) + 1 AS lfp_start_date,
            DATEADD (MONTH, -6, lfp_end_date) AS temporal_train_end_date)

-- 1.1 Getting all non Contact Us/Live Chat/MRC MOL
 , needed_data AS 
 (SELECT * 
  FROM (SELECT CASE WHEN lf.contact_id = 'Unknown' THEN lf.lead_id else lf.contact_id END       AS contact_or_lead_id
                ,lf.contact_id
                ,lf.lead_id 
                ,lf.lfp_wid 
                ,lf.mal_date
                ,lf.mql_date
                ,lf.sal_date
                ,lf.sql_date
                ,lf.sqo_date
                ,lf.swo_date
                ,lf.slo_date
                ,CASE WHEN lf.mql_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 ELSE 0 END          AS reached_mql
                ,CASE
                      WHEN lf.sal_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sal
                ,CASE 
                      WHEN lf.sal_expiration _date < TO_DATE('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sal_expiration
                ,CASE 
                      WHEN lf.sdl_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sdl
                ,CASE 
                      WHEN lf.sql_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sql
                ,CASE 
                      WHEN lf.sqo_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1 
                      ELSE 0 END                                                                         AS reached_sqo 
                ,CASE
                      WHEN lf.swo_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 1
                      ELSE 0 END                                                                         AS reached_ swo 
                ,CASE WHEN lf.slo_date < TO_DATE ('9999-12-31', 'YYYY-MM-DD') THEN 
                      ELSE 0 END                                                                         AS reached_slo
                ,CASE 
                      WHEN lower (sla tier c) = 'contact us' THEN 'Contact Us'
                      WHEN lower (campaign_category_c) = 'live chat' THEN 'Live Chat' 
                      WHEN lower (mrc_status_at_tsi_creation__c)= 'qualified - passed to sales' THEN 'MRC Generated' 
                      WHEN lower (cam.type) LIKE '%fast track%' AND lower (cam. sub_type__c) LIKE '%call down%'
                            THEN 'Fast Track - Calldown' 
                      WHEN lower (cam. type) LIKE '%fast track%' AND lower (cam. sub_type _c) LIKE '%boost%'
                            THEN 'Fast Track Boost' 
                      WHEN lower(cam. name) LIKE 'graze%' THEN 'RAZE' 
                      WHEN tsl. createdbyid = '0054z000008KeC9AAK' THEN 'Generated by Lorem' 
                      WHEN tsl. createdbyid = '00538000004CGWOAAM' THEN 'Generated by Marketo/System' 
                      WHEN tsl. createdbyid = '00550000001FBwjAAG' THEN 'Generated by Marketo/System' 
                      WHEN tsl. createdbyid = '00538000004c6aZAAA' THEN 'Generated by Marketo/System' 
                      WHEN tsl. createdbyid = '00550000003W9NaAAK' THEN 'Generated by Marketo/System' 
                      ELSE 'Others'
            END                                                                                           AS mql_type
                ,CASE WHEN reached_mal > 0 THEN 1 ELSE 0 END                                            reached_mql_score
                ,CASE WHEN reached_sal > 0 THEN 2 ELSE 0 END                                            reached_sal_score
                ,CASE WHEN reached_sql > 0 THEN 4 ELSE 0 END                                            reached_sal score
                ,CASE WHEN reached_sqo > 0 THEN 8 ELSE 0 END                                            reached_sqo_score
                ,CASE WHEN reached_swo > 0 THEN 16 ELSE 0 END                                           reached_swo_score
                ,CASE WHEN reached slo > 0 THEN 16 ELSE 0 END                                           reached_slo_score
                ,reached_mql_score + reached_sal_score + reached_sq1_score + reached_sqo_score + reached_swo_score + reached_slo_score AS progression_score
                ,lc.sfdc_account_id                                                                      AS account id 
                ,lc.email domain 
                ,CASE
                    WHEN lc.email_domain in ('gmail.com', 'hotmail.com', 'yahoo. com', 'outlook. com', 
                                             'aol.com', 'comcast.net', 'icloud.com', 'live.com', 'me.com'
                                             'verizon.net','packetstorm. com', 'allsocial. com', ' cnnbrasil.com.br', 
                                             'msn. com','mac.com', 'protonmail. com', 'example. com', 'itau-unibanco.com.br', 
                                             'qq. com', 'yandex. ru') THEN 1
                    WHEN lc.email_domain ilike '%yahoo' THEN 1
                    WHEN lc.email_domain ilike '%hotmail' THEN 1
                    WHEN lc.email_domain ilike '%testinator.com' THEN 1 
                    WHEN lc.email_domain IS NULL THEN 1 
                    ELSE 0
            END  
                ,NVL(ter.id, 'None')                                                                      AS has_freemail
                ,NVL(c.territory_lookup__c, l.territory_lookup__c)                                        As territory_lookup_c 
                ,NVL(ter-geo__c, lc.terr_geo_c)                                                           AS geo 
                ,NVL(ter.biz_unit__c, lc.terr_biz_unit_c)                                                 AS biz_unit
                ,NVL(NVL(ter.region__c, lc.terr_region_c), 'None')                                        AS region
                ,NVL(NVL(ter.sub_region__c, lc.terr_sub_region_c), 'None')                                AS sub_region
                ,NVL(NVL(ter.segment__c, lc.terr_segment_c), 'None')                                      AS segment
                ,NVL(NVL(ter.sub_segment__c, lc.sub_segment,__c), 'None')                                 AS sub_segment
                ,NVL(NVL(ter.name, lc.territory_name_c), 'None')                                          AS territory_name
                ,NVL(ter_phase_c, 'None')                                                                 as phase 
                ,NVL(c.level_of_aws_usage__c, l.level_of_aws_usage_c)                                     as level_of_aws_usage_c 
                ,lf.opportunity_id 
                ,tsl.industry_final_c 
                ,tsl.company_size_final_c
                ,tsl.job_title_final__c 
                ,tsl.lead _score_initial__c 
                ,NVL (NVL(c.ldr _solution_area__c, l.ldr_solution_area__c), 'None')                       AS dr_solution_area
                ,NVL (NVL(c.project_timeframe__c, L.project_timeframe__c), 'None')                        AS project_timeframe
                ,NVL (NVL (c.nature_of_inquiry__c, l.nature_of_inquiry__c), 'None')                       AS nature_of_inquiry
                ,NVL (NVL (c.job_role__c, l.job_role__c), tel.job_role_final__c)                          AS job_role
                ,NVL (NVL (c.title, l.title), tsl.job_title_final__c)                                     AS person_title
                ,CASE
                    WHEN (lower(person title) LIKE 'ceo' OR lower(person_title) LIKE '%chief executive officer%' OR
                          lower(person_title) LIKE '%founder%' OR lower(person_title) LIKE '%owner%') 
                          THEN 'Chief Executive Officer/Founder/Owner' 
                    WHEN (lower(person_title) LIKE '% vp%' OR lower(person_title) LIKE ' vp%' OR
                          lower(person_title) LIKE '$ svp%' OR lower(person_title) LIKE 'svp%' OR 
                          lower(person_title) LIKE '% vice%' OR lower (person_title) LIKE 'vice%' OR
                          lower(person_title) LIKE '% evp%' OR lower(person_title) LIKE 'evp%' OR 
                          lower(person_title) LIKE 'avp') THEN 'VP (incl. Senior/Exec/Asst)' 
                    WHEN (lower(person_title) LIKE '%managing director%' OR lower(person_title) LIKE '%president%' OR
                          lower(person_title) LIKE 'md' OR 
                          lower(person_title) LIKE 'executive' OR lower(person_title) LIKE 'business executive') 
                          THEN 'President/Managing Director/Business Exec.' 
                    WHEN (lower(person_title) LIKE '% dir %' OR lower(person_title) LIKE 'dir %' OR 
                          lower(person_title) LIKE '% dir. %' OR lower(person_title) LIKE 'dir. %' OR 
                          lower(person_title) LIKE '%director%') 
                          THEN 'Director' 
                    WHEN (lower(person_title) LIKE '%head%' OR lower(person_title) LIKE 'gm%' OR 
                          lower(person_title) LIKE '% gm' OR lower(person_title) LIKE '% gm %' OR 
                          (lower (person_title) LIKE '% gm %') ) 
                          THEN 'Head/GM' 
                    WHEN (lower(person_title) LIKE 'principal' OR lower(person_title) LIKE '%partner') 
                          THEN 'Partner/Principal' 
                    WHEN (Lower(person_title) LIKE 'to' OR lower(person_title) LIKE 'chief technology officer') 
                          THEN 'Chief Technology Officer' 
                    WHEN (lower(person_title) LIKE 'cpo' OR lower(person title) LIKE 'chief product officer' OR 
                          lower(person_title) LIKE 'chief commercial officer' OR 
                          lower(person_title) LIKE 'cco') 
                          THEN 'Chief Product/Commercial Officer' 
                    WHEN (Lower(person_title) LIKE 'cio' OR lower (person_title) LIKE '% cio %' OR 
                          Lower(person_title) LIKE 'cio %' OR lower (person_title) LIKE '% cio' OR 
                          lower(person_title) LIKE 'chief information officer' OR 
                          lower(person_title) LIKE 'chief digital officer') 
                          THEN 'Chief Information Officer'
                    WHEN (lower(person title) LIKE 'do' OR lower(person title) LIKE 'chief data officer' OR
                          lower(person title) LIKE 'chief data scientist') 
                          THEN 'Chief Data Officer' 
                    WHEN (lower(person_title) LIKE '%manager%' and (lower(person title) NOT LIKE '%product*' AND
                          lower(person_title) NOT LIKE '%program%' AND lower (person title) NOT LIKE '%project*') or
                          lower(person_title) LIKE 'sdm' OR lower(person_title) LIKE '%team lead%') 
                          THEN 'Manager (non-PM)' 
                    WHEN (lower(person_title) LIKE 'smanager%' and (lower (person_title) LIKE '%product%' OR 
                          lower(person_title) LIKE '%program%' OR lower (person_title) LIKE 'project*')) OR 
                          lower(person_title) LIKE 'pm' OR lower(person_title) LIKE 'tpm' OR lower(person title) LIKE 'Ascrum' OR
                          lower(person title) LIKE 'project*')
                          THEN 'Product/Project/Program Manager' 
                    WHEN (lower(person_title) LIKE '%engineer%' OR lower(person_title) LIKE '%developer%' OR 
                          lower(person_title) LIKE '$ eng%' OR lower(person title) LIKE 'sde' OR 
                          lower(person_title) LIKE 'sde %' OR lower (person title) LIKE 'sre' OR 
                          lower(person title) LIKE 'devops' OR lower(person title) LIKE 'qa%' OR 
                          lower(person title) LIKE 'programmer' or lower(person title) LIKE 'dev') 
                          THEN 'Engineer/Developer' 
                    WHEN lower (person_title) LIKE '%architects' OR (lower (person_title) LIKE '%tech%' AND l
                    ower(person_title) LIKE '% lead') OR lower (person_title) LIKE 'sa') 
                          THEN 'Architect/Tech Lead' 
                    WHEN (lower(person_title) LIKE '%admins' or lower(person_title) LIKE ' dba') 
                          THEN 'Administrator' 
                    WHEN (lower(person_title) LIKE '%analyst%') THEN 'Analyst' 
                    WHEN (Lower(person title) LIKE '%scientist%' OR lower(person_title) LIKE 'research%')
                          THEN 'Scientist' 
                    WHEN (lower(person_title) LIKE '%consult*') THEN 'Consultant' 
                    WHEN (lower(person title) LIKE '%accounts' OR lower(person title) LIKE '%sales%' OR
                          lower(person_title) LIKE '%rep*' OR lower(person_title) LIKE '%manager%' OR 
                          lower(person title) LIKE '%execs')
                          THEN 'Account Manager/Sales Rep.'
                    ELSE 'Other'
            END 
                , tsl.lead_source_final__c                                                                   AS extracted_person_title
                , tsl.initial_lead_source_c 
                , tsl.campaign_at_ts_creation_member_status__c
                , tsl.campaign_type_at_tsl_creation__c 
                , tsl.campaign_at_tsl_creation__c 
                , tsl.tsl_status 
                , tsl.completed_datetime__c 
                , tsl.createddate 
                , tsl.name  
                , ROW NUMBER()
                    OVER (PARTITION BY mql_number ORDER BY progression_score DESC)
                , ROW NUMBER() AS 
                    OVER (PARTITION BY contact_or lead_id, DATE_TRUNC('day', lf.mal_date) ORDER BY progression_score DESC) AS lfp_dedup_rnk

            FROM mdw_core.dim_sf_tsl tsl
                 JOIN mdw_core.dim_sf_lead_flow_process lf ON tsl.id = lf.tsl_id 
                 JOIN mdw_core.dim_sf_lead_contact lc ON lf.lc_du _merge_key = lc. du_merge_key 
                 LEFT JOIN mdw_core.dim_st_lead ON tsl.lead__c = l.lead_id
                 LEFT JOIN mdw_core.dim_sf_contact c on tsl.contact _c = c.contact_id 
                 JOIN mdu_core.dim_sf_territory ter ON lc.territory_name_c = ter.na 
                 LEFT JOIN mdw_core.dim_sf_campaign cam ON tsl.campaign_at_tsl_creation__c = cam.campaign_id 
            WHERE NVL(ter_geo__c, lc. terr_geo_c) in ('APAC', 'JAPN') 
                 AND NVL (ter.biz_unit__c, lc.terr_biz_unit_c) = 'CS' 
                 AND tsl.tsl_status__c in ('Completed Follow Up', 'Unactioned') 
                 AND NVL(tsl.contact__c, tsl.lead _c) != 'Unknown' 
                 AND NVL(tsl.contact__c, tsl.lead __c) IS NOT NULL 
                 AND lf.lc_du_delete_flag = 'N' -- filtering out deleted LCs
                 AND lf.tsl_dw_delete_flag = 'N' -- filtering out deleted TSLs
                 AND NVL(tsl.sla_tier__c, 'Blank') <> 'Contact Us' 
                 AND NVL(tsl.campaign_category__c, 'Blank') <>'Live Chat' 
                 AND nvl(tsl.mrc_status_at_tsi_creation__c,'Blank') <> 'Qualified - Passed to Sales' 
                 AND lf.mql_date BETWEEN (select lfp_start_date from var) AND (select lfp_end_date from var) 
                 AND (lf.ls_current_lfp = 'N' OR reached_sqo = 1) AND lf.mql_date >= '2022-01-19'
                 AND lf_mql_date < '9999-12-31' 
                 And mal_type not in ('Contact Us', 'MRC Generated') 
                 AND tsl.tsl_ status_ _c in ('Completed Follow Up', 'Initiated Follow Up')
                ) T  
            WHERE tsl_dedup_rnk = 1
              AND lfp_dedup_rnk = 1)

